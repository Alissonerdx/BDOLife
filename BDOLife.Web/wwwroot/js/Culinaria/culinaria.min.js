function AtualizarTotais(){let n=$("#resultadosGrid").jsGrid("option","data"),t=$("#ingredientesGrid").jsGrid("option","data");CalcularTotais(t,n)}function CalcularTotais(n,t){let i=0,r=0;if(n!==undefined&&n.length>0){for(let t=0;t<n.length;t++)if(n[t].ignorar===!1){let r=parseInt(Inputmask.unmask(`${n[t].quantidadeTotal}`,{alias:"prata"})),u=parseInt(Inputmask.unmask(`${n[t].precoMarket}`,{alias:"prata"})),f=r*u;i+=f}$("#custoTotal").html(Inputmask.format(`${i}`,{alias:"prata"}))}else $("#custoTotal").html(Inputmask.format("0",{alias:"prata"}));if(t!==undefined&&t.length>0){for(let n=0;n<t.length;n++)if(t[n].ignorar===!1){let i=parseInt(Inputmask.unmask(`${t[n].quantidade}`,{alias:"prata"})),u=parseInt(Inputmask.unmask(`${t[n].preco}`,{alias:"prata"}));r+=i*u}$("#lucroBruto").html(Inputmask.format(`${r}`,{alias:"prata"}))}else $("#lucroBruto").html(Inputmask.format("0",{alias:"prata"}));let u=parseInt((r-i)*.845),f=parseInt((r-i)*.65);u<0?(u=parseInt((r-i)*1.155),$("#lucroComPctEconomico").removeClass("valor-positivo"),$("#lucroComPctEconomico").addClass("valor-negativo"),$("#lucroComPctEconomico").html("-"+Inputmask.format(`${u}`,{alias:"prata"}))):($("#lucroComPctEconomico").removeClass("valor-negativo"),$("#lucroComPctEconomico").addClass("valor-positivo"),$("#lucroComPctEconomico").html(Inputmask.format(`${u}`,{alias:"prata"})));f<0?(f=parseInt((r-i)*1.35),$("#lucroSemPctEconomico").removeClass("valor-positivo"),$("#lucroSemPctEconomico").addClass("valor-negativo"),$("#lucroSemPctEconomico").html("-"+Inputmask.format(`${f}`,{alias:"prata"}))):($("#lucroSemPctEconomico").removeClass("valor-negativo"),$("#lucroSemPctEconomico").addClass("valor-positivo"),$("#lucroSemPctEconomico").html(Inputmask.format(`${f}`,{alias:"prata"})))}function ConfigurarMaestriaImperial(){$("#configuracaoMaestria").iziModal("open")}function SalvarMaestriaImperial(){maestriaImperialSelecionada=parseInt($("#maestriaImperialSelect").val());$("#configuracaoMaestria").iziModal("close")}function AlterarIngrediente(){if(ingredienteNodeSelecionado!==null){let t=$("#trocarIngrediente").find("#ingredienteAlternativo").select2("data")[0],i=$("#trocarIngrediente").find("#quantidadeIngrediente").val(),f=$("#trocarIngrediente").find("#precoUnitario").val(),r=ingredienteNodeSelecionado.parent,n=$("#treeViewContent").jstree("get_node",r),u=n.original.quantidade;if(n.id==="raiz"){let n=u*i;BuscarTreeView(t.id,$("#proc-normal").val(),n).then(function(n){console.log(n)})}console.log(n)}}function BuscarTreeView(n,t,i){return BlockElement("#treeView"),$.ajax({type:"POST",url:"/Culinaria/TreeViewSubReceita",data:{receitaReferenciaId:n,quantidade:i,procNormal:t},success:function(){UnblockElement("#treeView")}})}var maestriaImperialSelecionada=0,ingredienteNodeSelecionado=null;$(document).ready(function(){function n(){$("#trocarIngrediente").iziModal({title:"Alterar ingrediente",background:"#494C56",headerColor:"#33363F",width:"80%",radius:20,top:50,closeOnEscape:!1,overlayClose:!1,onOpening:function(){let u=$("#treeViewContent").jstree("get_selected")[0],t=$("#treeViewContent").jstree("get_node",u),i=t.parent.split("-"),r=i[i.length-1],n=$("#treeViewContent").jstree("get_node",t.parent);while((r.includes("PCH")||r.includes("PDE")||r.includes("RFI")||r.includes("PMO"))&&n.original.grupo!==null&&n.original.grupo!==undefined&&n.original.grupo!=="")t=n,i=n.parent.split("-"),r=i[i.length-1],n=$("#treeViewContent").jstree("get_node",n.parent);ingredienteNodeSelecionado=t;$("#trocarIngrediente").find("#grupoItemTrocaSelecionado").val(t.original.grupo)},afterRender:function(){$("#quantidadeIngrediente").inputmask({alias:"integer",allowMinus:!1,mask:"9999999"});$("#precoUnitario").inputmask({alias:"prata"});$("#trocarIngrediente").find("#ingredienteAlternativo").data("select2")&&$("#trocarIngrediente").find("#ingredienteAlternativo").val("").trigger("change");$("#ingredienteAlternativo").select2({placeholder:"Selecione o ingrediente",language:"pt-BR",width:"100%",dropdownCssClass:"increasedzindexclass",templateResult:formatState,templateSelection:formatState,ajax:{url:"/Item/SelectItensPorGrupo",type:"GET",data:function(n){return{search:n.term,page:n.page||1,grupo:$("#trocarIngrediente").find("#grupoItemTrocaSelecionado").val()}},processResults:function(n){return{results:n}}}});$("#ingredienteAlternativo").on("select2:select",function(){let n=$(this).select2("data")[0],t=n.valor;$("#precoUnitario").val(t)})}});$("#configuracaoMaestria").iziModal({title:"Configuração da Maestria",background:"#494C56",headerColor:"#33363F",radius:20,top:50,afterRender:function(){$("#maestriaImperialSelect").select2({placeholder:"Selecione a maestria (Entrega Imperial)",language:"pt-BR",width:"100%",dropdownCssClass:"increasedzindexclass",templateResult:formatState,templateSelection:formatState,allowClear:!0,ajax:{url:"/Maestria/SelectMaestriasCulinaria",type:"GET",data:function(n){return{search:n.term,page:n.page||1}},processResults:function(n){return n}}})}})}function t(){setInterval(AtualizarTotais,1e3)}function i(){$("#maestriaSelect").on("change",function(){let n=$(this).select2("data")[0];n!==undefined&&($("#proc-normal").inputmask("setvalue",n.procNormal),$("#proc-raro").inputmask("setvalue",n.procRaro),$("#proc-normal").focus(),$("#proc-raro").focus())});$("#consultarForm").on("submit",function(n){n.preventDefault();$("#ingredientesGrid").jsGrid("loadData");$("#resultadosGrid").jsGrid("loadData");$("#resultadosImperialGrid").jsGrid("loadData");$("#treeViewContent").jstree(!0).refresh()})}function r(){$("#receitaSelect").select2({placeholder:"Selecione a receita",language:"pt-BR",width:"100%",allowClear:!0,cacheDataSource:[],escapeMarkup:function(n){return n}});$("#maestriaSelect").select2({placeholder:"Selecione a maestria (Culinária)",language:"pt-BR",width:"100%",templateResult:formatState,templateSelection:formatState,allowClear:!0,ajax:{url:"/Maestria/SelectMaestriasCulinaria",type:"GET",data:function(n){return{search:n.term,page:n.page||1}},processResults:function(n){return n}}})}function u(){function n(n){var t=$("#ingredientesGrid").jsGrid("option","data");return t.filter(t=>t.id===n)[0]}function t(t){let r=t.original.id.split("-"),u=r[r.length-1],i=n(u);if(i===null||i===undefined){let n=Inputmask.format(`${parseInt(t.original.quantidade)*parseInt(t.original.valor)}`,{alias:"prata"});$("#ingredientesGrid").jsGrid("insertItem",{id:u,img:t.original.icon,item:t.original.nomeItem,quantidadeTotal:t.original.quantidade,precoMarket:t.original.valor,precoTotal:n,ignorar:!1})}else i.quantidadeTotal+=parseInt(t.original.quantidade),$("#ingredientesGrid").jsGrid("updateItem",i)}function i(t,i){let r=n(t);if(r!==null&&r!==undefined){let t=Inputmask.unmask(`${r.quantidadeTotal}`,{alias:"prata"}),n=parseInt(t)-parseInt(i);n===0?$("#ingredientesGrid").jsGrid("deleteItem",r):(r.quantidadeTotal=n,$("#ingredientesGrid").jsGrid("updateItem",r))}}$("#treeview-search").keyup(function(){$("#treeViewContent").jstree("search",$(this).val())});$("#treeViewContent").jstree({core:{dblclick_toggle:!1,animation:0,themes:{responsive:!0},data:function(n,t){BlockElement("#treeView");$.ajax({type:"POST",url:"/Culinaria/TreeView",data:{receitaReferenciaId:$("#receitaSelect").val(),quantidade:parseInt($("#quantidade").inputmask("unmaskedvalue")),procNormal:$("#proc-normal").val()},success:function(n){t(n);UnblockElement("#treeView")}})}},types:{},plugins:["contextmenu","search",],search:{case_insensitive:!0,show_only_matches:!0},contextmenu:{items:function(n){let t=n.original.grupo;return t!==null&&t!==""?{TrocarIngrediente:{separator_before:!1,separator_after:!1,label:"Trocar Ingrediente",action:function(){$("#trocarIngrediente").iziModal("open")}}}:null}}});$("#treeViewContent").on("open_node.jstree",function(i,r){let u=r.node.original,f=u.id.split("-"),e=f[f.length-1],o=$("#treeViewContent").jstree("get_children_dom",u);if($("#treeViewContent").jstree(!0).get_parent(r.node)!=="#"){let i=n(e),r=[];for(o.each(function(n,t){r.push($("#treeViewContent").jstree("get_node",t))});r.length>0;){let n=r.pop();if($("#treeViewContent").jstree("is_leaf",n)){let i=n.original.id.split("-"),r=i[i.length-1];t(n)}else{let t=$("#treeViewContent").jstree("get_children_dom",n);t.each(function(n,t){r.push($("#treeViewContent").jstree("get_node",t))})}}if(i!==null&&i!==undefined){let t=Inputmask.unmask(`${i.quantidadeTotal}`,{alias:"prata"}),n=parseInt(t)-parseInt(u.quantidade);n===0?$("#ingredientesGrid").jsGrid("deleteItem",i):(i.quantidadeTotal=n,$("#ingredientesGrid").jsGrid("updateItem",i))}}});$("#treeViewContent").bind("selected_node.jstree",function(n,t){for(var r=$("#treeViewContent").jstree(!0).get_json(t.node.id,{flat:!0}),i=0;i<r.length;i++)console.log(r[i])});$("#treeViewContent").on("close_node.jstree",function(t,r){let u=r.node.original,f=u.id.split("-"),e=f[f.length-1],o=$("#treeViewContent").jstree("get_children_dom",u);if($("#treeViewContent").jstree(!0).get_parent(r.node)!=="#"){let t=[];for(o.each(function(n,i){t.push($("#treeViewContent").jstree("get_node",i))});t.length>0;){let n=t.pop();if($("#treeViewContent").jstree("is_leaf",n)){let t=n.original.id.split("-"),r=t[t.length-1];i(r,n.original.quantidade)}else{$("#treeViewContent").jstree("open_all",n);let i=$("#treeViewContent").jstree("get_children_dom",n);i.each(function(n,i){t.push($("#treeViewContent").jstree("get_node",i))})}}let f=n(e);if(f===null||f===undefined){let n=Inputmask.format(`${parseInt(u.quantidade)*parseInt(u.valor)}`,{alias:"prata"});var s=r.node;$("#ingredientesGrid").jsGrid("insertItem",{id:e,img:u.icon,item:u.nomeItem,quantidadeTotal:u.quantidade,precoMarket:u.valor,precoTotal:n,ignorar:!1})}else f.quantidadeTotal+=parseInt(u.quantidade),$("#ingredientesGrid").jsGrid("updateItem",f)}});$("#treeViewContent").on("expandir",function(n){n.preventDefault();let r=$("#treeViewContent").jstree("get_node","raiz_anchor"),i=r.children;for(var t=0;t<i.length;t++)$("#treeViewContent").jstree("open_node",i[t])});$("#treeViewContent").on("agrupar",function(n){n.preventDefault();let r=$("#treeViewContent").jstree("get_node","raiz_anchor"),t=r.children,u=t.every(function(n){let t=$("#treeViewContent").jstree("get_node",n);return t.state.opened===!1});if(!u){$("#ingredientesGrid").jsGrid("option","data",[]);for(var i=0;i<t.length;i++){let n=$("#treeViewContent").jstree("get_node",t[i]);$("#treeViewContent").jstree("close_node",n)}}});$("#ingredientesGrid").off().on("keydown","input[type=text], input[type=number], select",n=>{n.which===13&&$("#ingredientesGrid").jsGrid("updateItem")});$("#resultadosGrid").off().on("keydown","input[type=text], input[type=number], select",n=>{n.which===13&&$("#resultadosGrid").jsGrid("updateItem")})}function f(){$("#ingredientesGrid").jsGrid({width:"100%",inserting:!1,editing:!0,sorting:!1,paging:!1,autoload:!1,selecting:!1,pageLoading:!1,confirmDeleting:!1,onItemUpdated:function(){$("#ingredientesGrid").jsGrid("refresh")},onRefreshed:function(n){var r=n.grid.option("data"),i={Id:"",Img:"",Item:"",QuantidadeTotal:0,PrecoMarket:0,PrecoTotal:0,IsTotal:!0},t;r.forEach(function(n){let t=0,r=0;t=typeof n.precoMarket=="string"?parseInt(Inputmask.unmask(n.precoMarket,{alias:"prata"})):n.precoMarket;r=typeof n.quantidadeTotal=="string"?parseInt(Inputmask.unmask(n.quantidadeTotal,{alias:"prata"})):n.quantidadeTotal;n.ignorar===!1&&(i.PrecoTotal+=r*t)});t=$("<tr>").addClass("total-row");n.grid._renderCells(t,i);n.grid._content.append(t)},fields:[{name:"id",visible:!1},{name:"img",align:"center",title:"",width:80,itemTemplate:function(n,t){return t.IsTotal?"Totais":t.img!==null&&t.img!==undefined&&t.img!==""?`<img src="${t.img}" style="max-width: 44px;"/>`:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsBAMAAADsqkcyAAAAFVBMVEXr6+sAAABYWFiSkpKwsLDNzc11dXVUvnWIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAOElEQVQokWNgGAUjAjABITINBcZAyMLgAKYRgCWYJRgkB6HhgNnN2Q2kFEIjiQMhyBAQPQoGPQAAoJ4FT0msjZwAAAAASUVORK5CYII=" style="max-width: 44px;"/>`}},{name:"item",title:"Ingrediente",type:"text",width:160,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?"":n}},{name:"quantidadeTotal",type:"prataField",title:"Quantidade Necessária",width:180,itemTemplate:function(n,t){return t.IsTotal?"":Inputmask.format(`${n}`,{alias:"prata"})}},{name:"precoMarket",type:"prataField",title:"Custo no Mercado (UN)",width:180,itemTemplate:function(n,t){return t.IsTotal?"":Inputmask.format(`${n}`,{alias:"prata"})}},{name:"precoTotal",type:"prataField",title:"Custo Total",width:120,editing:!1,inserting:!1,itemTemplate:function(n,t){if(t.IsTotal)return Inputmask.format(`${t.PrecoTotal}`,{alias:"prata"});let i=parseInt(Inputmask.unmask(`${t.precoMarket}`,{alias:"prata"})),r=parseInt(Inputmask.unmask(`${t.quantidadeTotal}`,{alias:"prata"}));return Inputmask.format(`${r*i}`,{alias:"prata"})}},{name:"ignorar",type:"checkbox",title:"Ignorar",width:120,itemTemplate:function(n,t){return t.IsTotal?"":$("<input>").prop("type","checkbox").attr("checked",n).attr("disabled",!0)}},{type:"control",deleteButton:!1,editButton:!1,itemTemplate:function(){return jsGrid.fields.control.prototype.itemTemplate.apply(this,arguments)}}],controller:{loadData:function(){BlockElement("#consultarForm");var n=$.Deferred();return $.post({url:"/Culinaria/Ingredientes",data:{receitaReferenciaId:$("#receitaSelect").val(),quantidade:parseInt($("#quantidade").inputmask("unmaskedvalue")),procNormal:$("#proc-normal").val()},dataType:"json"}).done(function(t){n.resolve(t);UnblockElement("#consultarForm")}),n.promise()}}});$("#resultadosGrid").jsGrid({width:"100%",inserting:!1,editing:!0,sorting:!1,paging:!1,autoload:!0,selecting:!1,pageLoading:!1,onItemUpdated:function(){$("#resultadosGrid").jsGrid("refresh")},onRefreshed:function(n){var r=n.grid.option("data"),t={Img:"",Item:"",Quantidade:0,Preco:0,Total:0,QuantidadePorCaixaImperial:0,CaixaImperial:"",QuantidadeImperial:0,ValorPorCaixa:0,PrecoPorCaixa:0,TotalImperial:0,IsTotal:!0},i;r.forEach(function(n){let i=0,r=0;i=typeof n.preco=="string"?parseInt(Inputmask.unmask(n.preco,{alias:"prata"})):n.preco;r=typeof n.quantidade=="string"?parseInt(Inputmask.unmask(n.quantidade,{alias:"prata"})):n.quantidade;n.ignorar===!1&&(t.QuantidadeImperial+=n.quantidadeImperial,t.Total+=r*i,t.TotalImperial+=n.quantidadeImperial*n.precoPorCaixa,t.PrecoPorCaixa=n.precoPorCaixa)});i=$("<tr>").addClass("total-row");n.grid._renderCells(i,t);n.grid._content.append(i)},fields:[{name:"img",align:"center",title:"",width:80,itemTemplate:function(n,t){return t.IsTotal?"Totais":t.img!==null&&t.img!==undefined&&t.img!==""?`<img src="${t.img}" style="max-width: 44px;"/>`:`<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsBAMAAADsqkcyAAAAFVBMVEXr6+sAAABYWFiSkpKwsLDNzc11dXVUvnWIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAOElEQVQokWNgGAUjAjABITINBcZAyMLgAKYRgCWYJRgkB6HhgNnN2Q2kFEIjiQMhyBAQPQoGPQAAoJ4FT0msjZwAAAAASUVORK5CYII=" style="max-width: 44px;"/>`}},{name:"item",title:"Produzido",type:"text",width:160,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?"":n}},{name:"quantidade",type:"prataField",title:"Qtd. Produzida",width:120,itemTemplate:function(n,t){return t.IsTotal?"":Inputmask.format(`${n}`,{alias:"prata"})}},{name:"preco",type:"prataField",title:"Preço Mercado",width:120,itemTemplate:function(n,t){return t.IsTotal?"":Inputmask.format(`${n}`,{alias:"prata"})}},{name:"total",type:"prataField",title:"Lucro Bruto",width:120,editing:!1,inserting:!1,itemTemplate:function(n,t){if(t.IsTotal)return Inputmask.format(`${t.Total}`,{alias:"prata"});let i=parseInt(Inputmask.unmask(`${t.preco}`,{alias:"prata"})),r=parseInt(Inputmask.unmask(`${t.quantidade}`,{alias:"prata"})),u=r*i;return Inputmask.format(`${u}`,{alias:"prata"})}},{name:"quantidadePorCaixaImperial",type:"text",title:"Caixa Imperial",visible:!1,width:120,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?"":n}},{name:"caixaImperial",type:"text",title:"Caixa Imperial",width:120,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?"":n}},{name:"quantidadeImperial",type:"prataField",title:"Qtd. Caixa Imperial",width:160,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?`${t.QuantidadeImperial} x ${Inputmask.format(`${t.PrecoPorCaixa}`,{alias:"prata"})} = ${Inputmask.format(`${t.TotalImperial}`,{alias:"prata"})}`:n}},{name:"precoPorCaixa",type:"prataField",title:"Valor/Caixa",width:120,editing:!1,inserting:!1,itemTemplate:function(n,t){return t.IsTotal?"":Inputmask.format(`${n}`,{alias:"prata"})}},{name:"totalImperial",type:"prataField",title:"Valor/Caixa",width:120,visible:!1,editing:!1,inserting:!1},{name:"ignorar",type:"checkbox",title:"Ignorar",width:120,itemTemplate:function(n,t){return t.IsTotal?"":$("<input>").prop("type","checkbox").attr("checked",n).attr("disabled",!0)}},{type:"control",deleteButton:!1,editButton:!1,itemTemplate:function(n,t){if(t.IsTotal)return"";return jsGrid.fields.control.prototype.itemTemplate.apply(this,arguments)}}],controller:{loadData:function(){BlockElement($("#resultados"));var n=$.Deferred();return $.post({url:"/Culinaria/Resultados",data:{receitaReferenciaId:$("#receitaSelect").val(),quantidade:parseInt($("#quantidade").inputmask("unmaskedvalue")),procNormal:$("#proc-normal").val(),procRaro:$("#proc-raro").val(),maestria:$("#maestriaSelect").val(),maestriaImperial:maestriaImperialSelecionada},dataType:"json"}).done(function(t){n.resolve(t);UnblockElement($("#resultados"))}),n.promise()}}})}f();r();i();u();t();n()});